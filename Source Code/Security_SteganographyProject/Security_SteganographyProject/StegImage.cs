using System;
using System.Collections;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Data;
using System.IO;
using System.Drawing;
using System.Runtime.InteropServices;
using System.Runtime.Serialization.Formatters.Binary;
using System.Windows.Media.Imaging;

namespace Security_SteganographyProject
{
    public class StegImage : StegFile
    {
        // Fields

        private Image image;
        private Bitmap bitmap;
        private FileStream fs;
        private BufferedStream bs;
        private AES aes;
        private RSA rsaMsg, rsaMsgLen, rsaAes;
        private string imageLocation;
        private int x, y, xSize, ySize;
        private int xMessageStart, yMessageStart;
        private int key;

        // Public Constructor

        public StegImage(string fileName)
        {
            /*if (!(fileName.ToLower().EndsWith("bmp") || fileName.ToLower().EndsWith("png")))
                MessageBox.Show("Please select a \"bmp\" or a \"png\" file.", "Invalid File", MessageBoxButtons.OK, MessageBoxIcon.Information);
            else*/
            {
                image = Image.FromFile(fileName);
                imageLocation = fileName;
                x = 0;
                y = 0;
                xSize = image.Width;
                ySize = image.Height;
                image.Dispose();
                image = null;
            }
        }

        // Properties

        public int Key
        {
            get
            {
                return key;
            }
        }

        public string FileLocation
        {
            get
            {
                return imageLocation;
            }
        }

        public long Capacity
        {
            get
            {
                return ((xSize * ySize / 3) - 512);
            }
        }

        // Private Methods

        private void EmbedByteArray(byte[] content, int spacing)
        {
            byte[] bits = null;
            //int l = 0, a;
            Color currentPixel1 = new Color();
            Color currentPixel2 = new Color();
            Color currentPixel3 = new Color();


            for (int i = 0; i < content.Length; i++)
            {
                bits = Converter.GetBits(content[i]);

                currentPixel1 = bitmap.GetPixel(x, y);
                currentPixel1 = Color.FromArgb(ReplaceLastBit(currentPixel1.R, bits[0]), ReplaceLastBit(currentPixel1.G, bits[1]), ReplaceLastBit(currentPixel1.B, bits[2]));
                bitmap.SetPixel(x, y, currentPixel1);
                SetNextPixel(spacing);

                currentPixel2 = bitmap.GetPixel(x, y);
                currentPixel2 = Color.FromArgb(ReplaceLastBit(currentPixel2.R, bits[3]), ReplaceLastBit(currentPixel2.G, bits[4]), ReplaceLastBit(currentPixel2.B, bits[5]));
                bitmap.SetPixel(x, y, currentPixel2);
                SetNextPixel(spacing);

                currentPixel3 = bitmap.GetPixel(x, y);
                currentPixel3 = Color.FromArgb(ReplaceLastBit(currentPixel3.R, bits[6]), ReplaceLastBit(currentPixel3.G, bits[7]), currentPixel3.B);
                bitmap.SetPixel(x, y, currentPixel3);
                SetNextPixel(spacing);
            }
        }

        private bool EmbedContent(byte[] msgBytes, string keyString)
        {
            image = Image.FromFile(imageLocation);
            bitmap = new Bitmap(image);

            key = GenerateKey(keyString);
            byte[] keyBytes = rsaMsg.Encrypt(Converter.GetBytes((long)key));
            if (keyBytes == null)
                return false;
            if ((msgBytes.Length + 512) >= (xSize * ySize / 3))
                return false;
            
            Reset();

            //---key
            EmbedByteArray(keyBytes, 1);

            xMessageStart = x;
            yMessageStart = y;

            //---message
                //Embed message length
            EmbedByteArray(rsaMsgLen.Encrypt(Converter.GetBytes(msgBytes.Length)), key);
                //Embed message
            EmbedByteArray(msgBytes, key);

            //---aes key,iv

            //---embedding done

            if (File.Exists("tempImg.bmp"))
                File.Delete("tempImg.bmp");
            bitmap.Save("tempImg.bmp");
            imageLocation = "tempImg.bmp";

            bitmap.Dispose();
            image.Dispose();
            image = bitmap = null;

            Reset();
            return true;
        }

        private bool EmbedContent(byte[] msgBytes, string keyString, bool saveEncryptedContent, string saveEncContentLocation)
        {
            image = Image.FromFile(imageLocation);
            bitmap = new Bitmap(image);
            aes = new AES();

            key = GenerateKey(keyString);
            byte[] keyBytes = rsaMsg.Encrypt(Converter.GetBytes((long)key));
            if (keyBytes == null)
                return false;
            byte[] cphrBytes = aes.Encrypt(msgBytes);
            if (cphrBytes == null)
                return false;
            else if (saveEncryptedContent)
            {
                try
                {
                    fs = new FileStream(saveEncContentLocation, FileMode.Create, FileAccess.Write, FileShare.None);
                    bs = new BufferedStream(fs);
                    bs.Write(cphrBytes, 0, cphrBytes.Length);
                }
                finally
                {
                    if (bs != null)
                        bs.Close();
                    if (fs != null)
                        fs.Close();
                }
            }
            byte[] aesKeyBytesEnc = rsaAes.Encrypt(aes.Key);
            if (aesKeyBytesEnc == null)
                return false;
            byte[] aesIVBytesEnc = rsaAes.Encrypt(aes.InitVector);
            if (aesIVBytesEnc == null)
                return false;

            if ((cphrBytes.Length + 512) >= (xSize * ySize / 3))
                return false;
            Reset();

            //---key
            EmbedByteArray(keyBytes, 1);

            xMessageStart = x;
            yMessageStart = y;

            //---message
            //Embed message length
            EmbedByteArray(rsaMsgLen.Encrypt(Converter.GetBytes(cphrBytes.Length)), key);
            //Embed message
            EmbedByteArray(cphrBytes, key);

            //---aes key,iv
            EmbedByteArray(aesKeyBytesEnc, key);
            EmbedByteArray(aesIVBytesEnc, key);

            //---embedding done

            if (File.Exists("tempImg.bmp"))
                File.Delete("tempImg.bmp");
            bitmap.Save("tempImg.bmp");
            imageLocation = "tempImg.bmp";

            bitmap.Dispose();
            image.Dispose();
            image = bitmap = null;

            Reset();
            return true;
        }

        private byte[] ExtractBytes(int keyx, int length) // Extract 'count' number of bytes
        {
            byte[] extracted = new byte[length];
            byte currentByte;
            Color currentPixel1 = new Color();
            Color currentPixel2 = new Color();
            Color currentPixel3 = new Color();

            for (int i = 0; i < length; i++)
            {
                currentPixel1 = bitmap.GetPixel(x, y);
                SetNextPixel(keyx);
                currentPixel2 = bitmap.GetPixel(x, y);
                SetNextPixel(keyx);
                currentPixel3 = bitmap.GetPixel(x, y);
                SetNextPixel(keyx);

                currentByte = GetByteFromPixels(currentPixel1, currentPixel2, currentPixel3);
                extracted[i] = currentByte;
            }

            return extracted;
        }

        private byte[] ExtractContent()
        {
            image = Image.FromFile(imageLocation);
            bitmap = new Bitmap(image);

            Reset();
            byte[] keyBytes = rsaMsg.Decrypt(ExtractBytes(1, 128));
            key = (int)Converter.GetLong(keyBytes);
            xMessageStart = x;
            yMessageStart = y;
            int messageLength = (int)Converter.GetLong(rsaMsgLen.Decrypt(ExtractBytes(key, 128)));
            if (messageLength == -1)
                return null;
            byte[] messageBytes = ExtractBytes(key, messageLength);
            if (messageBytes == null)
                return null;

            Reset();

            bitmap.Dispose();
            image.Dispose();
            image = bitmap = null;
            return messageBytes;
        }

        private byte[] ExtractContent(bool saveEncryptedContent, string saveEncContentLocation)
        {
            image = Image.FromFile(imageLocation);
            bitmap = new Bitmap(image);
            aes = new AES();

            Reset();
            byte[] keyBytes = rsaMsg.Decrypt(ExtractBytes(1, 128));
            key = (int)Converter.GetLong(keyBytes);
            xMessageStart = x;
            yMessageStart = y;
            int messageLength = (int)Converter.GetLong(rsaMsgLen.Decrypt(ExtractBytes(key, 128)));
            if (messageLength == -1)
                return null;
            byte[] messageBytes = ExtractBytes(key, messageLength);
            if (messageBytes == null)
                return null;
            else if (saveEncryptedContent)
            {
                try
                {
                    fs = new FileStream(saveEncContentLocation, FileMode.Create, FileAccess.Write, FileShare.None);
                    bs = new BufferedStream(fs);
                    bs.Write(messageBytes, 0, messageBytes.Length);
                }
                finally
                {
                    if (bs != null)
                        bs.Close();
                    if (fs != null)
                        fs.Close();
                }
            }
            byte[] aesKeyBytes = rsaAes.Decrypt(ExtractBytes(key, 128));
            if (aesKeyBytes == null)
                return null;
            byte[] aesIVBytes = rsaAes.Decrypt(ExtractBytes(key, 128));
            if (aesIVBytes == null)
                return null;
            byte[] decryptedMsgBytes = aes.Decrypt(messageBytes, aesKeyBytes, aesIVBytes);
            if (decryptedMsgBytes == null)
                return null;
            Reset();

            bitmap.Dispose();
            image.Dispose();
            image = bitmap = null;
            return decryptedMsgBytes;
        }

        private int GenerateKey(string keyString) // Generates the sum of the ASCII values of all the characters ofkeyString
        {
            int num = 0;
            char[] keyChars = keyString.ToCharArray();
            for (int i = 0; i < keyString.Length; i++)
            {
                num += (int)keyChars[i];
            }
            return num;
        }
        
        private byte GetByteFromPixels(Color pixel1, Color pixel2, Color pixel3)
        {
            byte currentByte = 0;

            currentByte |= (byte)(pixel1.R & 1);
            currentByte |= (byte)((byte)(pixel1.G & 1) << 1);
            currentByte |= (byte)((byte)(pixel1.B & 1) << 2);
            currentByte |= (byte)((byte)(pixel2.R & 1) << 3);
            currentByte |= (byte)((byte)(pixel2.G & 1) << 4);
            currentByte |= (byte)((byte)(pixel2.B & 1) << 5);
            currentByte |= (byte)((byte)(pixel3.R & 1) << 6);
            currentByte |= (byte)((byte)(pixel3.G & 1) << 7);

            return currentByte;
        }

        private byte ReplaceLastBit(byte byt1, byte byt2)//replace lest bit of byt1 by byt2
        {
            if (byt1 % 2 == 0)
                if (byt2 == 0)
                    return byt1;
                else
                    return (byte)(byt1 + 1);
            else
                if (byt2 == 0)
                    return (byte)(byt1 - 1);
                else
                    return byt1;
            /*if (byt2 == 0)
                return (byte)(byt1 & (byte)254);
            return (byte)(byt1 & (byte)255);*/
        }

        private void Reset() // Resets x and y to 0
        {
            x = 0;
            y = 0;
            xMessageStart = 0;
            xMessageStart = 0;
        }

        private void SetNextPixel(int next)
        {
            if (x != 0 || y != 0)
            {
                x += next;
                if (x >= xSize)
                    y++;
                if (y < ySize)
                    x %= xSize;
                else //If end of image file reached
                {
                    x = ++xMessageStart;
                    if (x >= xSize)
                        yMessageStart++;
                    x %= xSize;
                    y = yMessageStart;
                }
            }
            else if (y == 0)
            {
                x += next;
            }
        }

        private FileInfo ToFile(byte[] bytes) // Convert byte[] object to FileInfo object
        {
            FileInfo file = null;
            if (bytes == null)
                return null;

            try
            {
                file = new FileInfo("tempExtractedFile.tmp");
                fs = new FileStream(file.FullName, FileMode.Create, FileAccess.Write, FileShare.None);
                bs = new BufferedStream(fs);
                bs.Write(bytes, 0, bytes.Length);
            }
            finally
            {
                if (bs != null)
                    bs.Close();
                if (fs != null)
                    fs.Close();
            }

            return file;
        }

        // Public Methods

        public bool EmbedText(string messageText, string keyString, ref RSA rsaMsgx, ref RSA rsaAesy, ref RSA rsaMsgLenx, bool encryptionEnabled, bool saveEncryptedContent, string saveEncContentLocation)
        {
            byte[] msgBytes = Converter.GetBytes(messageText);
            if (rsaMsg != null)
                rsaMsg.Dispose();
            rsaMsg = rsaMsgx;
            if (rsaAes != null)
                rsaAes.Dispose();
            rsaAes = rsaAesy;
            if (rsaMsgLen != null)
                rsaMsgLen.Dispose();
            rsaMsgLen = rsaMsgLenx;
            if (encryptionEnabled)
                return EmbedContent(msgBytes, keyString, saveEncryptedContent, saveEncContentLocation);
            else
                return EmbedContent(msgBytes, keyString);
        }

        public bool EmbedFile(string messageFile, string keyString, ref RSA rsaMsgx, ref RSA rsaAesy, ref RSA rsaMsgLenx, bool encryptionEnabled, bool saveEncryptedContent, string saveEncContentLocation)
        {
            byte[] msgBytes = null;
            if (rsaMsg != null)
                rsaMsg.Dispose();
            rsaMsg = rsaMsgx;
            if (rsaAes != null)
                rsaAes.Dispose();
            rsaAes = rsaAesy;
            if (rsaMsgLen != null)
                rsaMsgLen.Dispose();
            rsaMsgLen = rsaMsgLenx;
            try
            {
                fs = new FileStream(messageFile, FileMode.Open, FileAccess.Read);
                bs = new BufferedStream(fs);
                msgBytes = new byte[bs.Length];
                bs.Read(msgBytes, 0, (int)bs.Length);
            }
            finally
            {
                if (bs != null)
                    bs.Dispose();
                if (fs != null)
                    fs.Dispose();
            }

            if (encryptionEnabled)
                return EmbedContent(msgBytes, keyString, saveEncryptedContent, saveEncContentLocation);
            else
                return EmbedContent(msgBytes, keyString);
        }

        public string ExtractText(ref RSA rsaMsgx, ref RSA rsaAesy, ref RSA rsaMsgLenx, bool decryptionEnabled, bool saveEncryptedContent, string saveEncContentLocation)
        {
            if (rsaMsg != null)
                rsaMsg.Dispose();
            rsaMsg = rsaMsgx;
            if (rsaAes != null)
                rsaAes.Dispose();
            rsaAes = rsaAesy;
            if (rsaMsgLen != null)
                rsaMsgLen.Dispose();
            rsaMsgLen = rsaMsgLenx;
            if (decryptionEnabled)
                return (Converter.GetString(ExtractContent(saveEncryptedContent, saveEncContentLocation)));
            return (Converter.GetString(ExtractContent()));
        }

        public FileInfo ExtractFile(ref RSA rsaMsgx, ref RSA rsaAesx, ref RSA rsaMsgLenx, bool decryptionEnabled, bool saveEncryptedContent, string saveEncContentLocation)
        {
            if (rsaMsg != null)
                rsaMsg.Dispose();
            rsaMsg = rsaMsgx;
            if (rsaAes != null)
                rsaAes.Dispose();
            rsaAes = rsaAesx;
            if (rsaMsgLen != null)
                rsaMsgLen.Dispose();
            rsaMsgLen = rsaMsgLenx;
            if (decryptionEnabled)
                return ToFile(ExtractContent(saveEncryptedContent, saveEncContentLocation));
            return ToFile(ExtractContent());
        }

        public void Save(string destinationFileName, string type)
        {
            try
            {
                image = Image.FromFile(imageLocation);
                bitmap = new Bitmap(image);
                fs = new FileStream(destinationFileName, FileMode.Create, FileAccess.Write, FileShare.None);
                bs = new BufferedStream(fs);
                if (type == "bmp")
                    bitmap.Save(bs, System.Drawing.Imaging.ImageFormat.Bmp);
                else if (type == "png")
                    bitmap.Save(bs, System.Drawing.Imaging.ImageFormat.Png);
            }
            finally
            {
                if (bs != null)
                    bs.Close();
                if (fs != null)
                    fs.Close();
                if (image != null)
                {
                    image.Dispose();
                    image = null;
                }
            }
        }

        // GC Funtions

        protected virtual void Dispose(bool disposing)
        {
            if (disposing)
            {
                if (image != null)
                {
                    image.Dispose();
                    image = null;
                }
                if (bitmap != null)
                    bitmap.Dispose();
                if (bs != null)
                    bs.Dispose();
                if (fs != null)
                    fs.Dispose();
                if (rsaMsg != null)
                    rsaMsg.Dispose();
                if (rsaAes != null)
                    rsaAes.Dispose();
                if (aes != null)
                    aes.Dispose();
            }
        }

        public void Dispose()
        {
            Dispose(true);
            GC.SuppressFinalize(this);
        }
    }
}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             